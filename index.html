<html
	<head>
		<title>Integrations</title>
		<link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.0/build/styles/default.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.0/build/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script type="text/javascript" charset="utf-8">
      $(document).ready(function() {

        $("#apply").click(function() {
          var results   = {} // API responses, de-deuplicated
          var deferreds = []

          var integrations = JSON.parse($("#code").text());
          $("#integrations").empty();

          for (var integration of integrations) {
            for (var modname of integration.modules) {
              if (! results.hasOwnProperty(modname)) {
//                 var deferred = $.getJSON( "https://forgeapi.puppet.com/v3/modules/"+modname, function(results) {
                var deferred = $.getJSON( "data/"+modname+".json", function(data) {
                  results[modname] = data;
                });
                deferreds.push(deferred);
              }
            }

            var container = $("<div>").appendTo("#integrations").addClass("module").attr("id", integration.name);
            $("<img>").appendTo(container).addClass("icon").attr("src", integration.icon);
            $("<h3>").appendTo(container).addClass("title").text(integration.name);
            $("<div>").appendTo(container).addClass("description").text(integration.description);
          }

          $.when.apply($, deferreds).then(function() {
            for (var integration of integrations) {
              var container = $("#integrations .module#"+integration.name);
              var modlist   = $("<ul>").appendTo(container).addClass("modules");

              for (var modname of integration.modules) {
                var module    = results[modname];
                var forgename = module.slug.replace("-", "/");
                var released  = new Date(module.current_release.updated_at.split(" ")[0]).toDateString();

                modlist.append(
                  $("<li>").append(
                    $("<div>", {"class": "inner"}).append(
                      $("<a>").attr("href", "https://forge.puppet.com/"+forgename).append(
                        $("<div>", {"class": "name"}).text(forgename)
                      ),
                      $("<p>", {"class": "summary"}).text(module.current_release.metadata.summary),
                      $("<div>", {"class": "details"}).append(
                        $("<div>", {"class": "left"}).append(
                          $("<strong>").text("Author"),
                          $("<span>").text(module.current_release.metadata.author)
                        ),
                        $("<div>", {"class": "right"}).append(
                          $("<strong>").text("Last release"),
                          $("<span>").text(module.current_release.version+" ("+released+")")
                        )
                      )
                    )
                  )
                );

              }
            }
          });

        });

      });
    </script>

    <style>
    </style>

	</head>
	<body>
    <h1>Look at some of our nifty integrations!</h1>
    <div id="config">
      <pre><code id="code" contenteditable="true">[
  {
    "name": "Atlassian",
    "icon": "https://www.atlassian.com/assets/img/icons/imkt/imkt-navbar__charlie-logo.svg",
    "description": "Atlassian is an Australian enterprise software multinational that develops products for software development, project management, and content management. Its well-known products include issue tracking application Jira and its team collaboration and wiki product Confluence.",
    "search": "atlassian",
    "modules": [
      "puppet-confluence",
      "puppet-jira",
      "puppet-stash",
      "joshbeard-bamboo",
      "thewired-bitbucket"
    ]
},
{
    "name": "Atlassian",
    "icon": "https://www.atlassian.com/assets/img/icons/imkt/imkt-navbar__charlie-logo.svg",
    "description": "Atlassian is an Australian enterprise software multinational that develops products for software development, project management, and content management. Its well-known products include issue tracking application Jira and its team collaboration and wiki product Confluence.",
    "search": "atlassian",
    "modules": [
      "puppet-confluence",
      "puppet-jira",
      "puppet-stash",
      "joshbeard-bamboo",
      "thewired-bitbucket"
    ]
  }
]</pre></code>
      <input type="button" id="apply" value="Render Widgets" />
    </div>
    <div id="integrations"></div>
	</body>
</html>
